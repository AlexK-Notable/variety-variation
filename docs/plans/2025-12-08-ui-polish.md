# UI Polish - Implementation Plan

**Date:** 2025-12-08
**Status:** Planned
**Agent:** 42d0d136

---

## Current State Analysis

### Extract Palettes Button
**Location:** `PreferencesVarietyDialog.py` lines 1886-1949

**Current Behavior:**
- Shows confirmation dialog with estimated count
- Disables button and changes label to "Extracting... {%}%"
- Runs extraction in background thread
- Re-enables button on completion

**Problems:**
1. No visual progress bar - only text percentage
2. No cancel button - extraction can take minutes
3. Button state managed via label changes (fragile)

### Thumbnail Loading
**Location:** `PreferencesVarietyDialog.py` lines 2206-2249

**Current Behavior:**
- Uses `ThreadPoolExecutor(max_workers=4)`
- `GObject.idle_add()` for thread-safe updates
- Placeholder images shown immediately

**Assessment:** Already correctly implemented. No changes needed.

### Wallust Check
**Location:** `PreferencesVarietyDialog.py` lines 1414-1436

**Current Behavior:**
- Checks `shutil.which('wallust')` when toggling ON
- Shows notification if missing
- Disables checkbox

**Assessment:** Basic check exists. Could be enhanced with detailed installation dialog.

---

## Implementation Plan

### 1. Progress Bar Widget

Add to `PreferencesVarietyDialog.ui`:

```xml
<!-- Extract Palettes Progress Section -->
<child>
  <object class="GtkBox" id="smart_extraction_progress_box">
    <property name="visible">False</property>
    <property name="margin_left">30</property>
    <property name="margin_right">15</property>
    <property name="margin_top">5</property>
    <property name="spacing">10</property>
    <child>
      <object class="GtkProgressBar" id="smart_extraction_progress">
        <property name="visible">True</property>
        <property name="hexpand">True</property>
        <property name="show_text">True</property>
      </object>
      <packing>
        <property name="expand">True</property>
        <property name="fill">True</property>
        <property name="position">0</property>
      </packing>
    </child>
    <child>
      <object class="GtkButton" id="smart_extraction_cancel">
        <property name="label" translatable="yes">Cancel</property>
        <property name="visible">True</property>
        <signal name="clicked" handler="on_smart_extraction_cancel_clicked"/>
      </object>
      <packing>
        <property name="expand">False</property>
        <property name="position">1</property>
      </packing>
    </child>
  </object>
</child>
```

### 2. Updated Extract Handler

```python
def on_smart_extract_palettes_clicked(self, widget=None):
    """Extract color palettes for all indexed images."""
    if not hasattr(self.parent, 'smart_selector') or not self.parent.smart_selector:
        return

    # Check wallust availability first
    if not shutil.which('wallust'):
        self._show_wallust_required_dialog()
        return

    # Get count of images without palettes
    stats = self.parent.smart_selector.get_statistics()
    images_without = stats['images_indexed'] - stats['images_with_palettes']

    if images_without == 0:
        self.parent.show_notification(_("All images already have palettes"))
        return

    # Show confirmation dialog
    dialog = Gtk.MessageDialog(
        self,
        Gtk.DialogFlags.MODAL,
        Gtk.MessageType.INFO,
        Gtk.ButtonsType.YES_NO,
        _("Extract color palettes for {} images?\n\n"
          "This may take several minutes for large collections.\n"
          "You can cancel at any time.").format(images_without)
    )
    dialog.set_title(_("Extract Palettes"))
    response = dialog.run()
    dialog.destroy()

    if response != Gtk.ResponseType.YES:
        return

    # Reset cancellation flag
    self._extraction_cancelled = False

    # Show progress UI
    self.ui.smart_extract_palettes.set_sensitive(False)
    self.ui.smart_extraction_progress_box.set_visible(True)
    self.ui.smart_extraction_progress.set_fraction(0.0)
    self.ui.smart_extraction_progress.set_text(_("Starting..."))
    self.ui.smart_extraction_cancel.set_sensitive(True)

    def progress_callback(current, total):
        if self._extraction_cancelled:
            raise InterruptedError("Extraction cancelled by user")

        def _update():
            if total > 0:
                fraction = current / total
                self.ui.smart_extraction_progress.set_fraction(fraction)
                self.ui.smart_extraction_progress.set_text(
                    _("{current} / {total} ({pct}%)").format(
                        current=current, total=total, pct=int(fraction * 100)
                    )
                )
        Util.add_mainloop_task(_update)

    def extract():
        try:
            count = self.parent.smart_selector.extract_all_palettes(
                progress_callback=progress_callback
            )

            def _on_success():
                self.update_smart_selection_stats()
                self.parent.show_notification(_("Extracted {} palettes").format(count))
            Util.add_mainloop_task(_on_success)

        except InterruptedError:
            def _on_cancelled():
                self.parent.show_notification(_("Palette extraction cancelled"))
            Util.add_mainloop_task(_on_cancelled)

        except Exception:
            logger.exception("Error extracting palettes")
            def _on_error():
                self.parent.show_notification(_("Palette extraction failed"))
            Util.add_mainloop_task(_on_error)

        finally:
            def _restore():
                self.ui.smart_extraction_progress_box.set_visible(False)
                self.ui.smart_extract_palettes.set_sensitive(True)
            Util.add_mainloop_task(_restore)

    self._extraction_thread = threading.Thread(target=extract, daemon=True)
    self._extraction_thread.start()

def on_smart_extraction_cancel_clicked(self, widget=None):
    """Cancel ongoing palette extraction."""
    self._extraction_cancelled = True
    self.ui.smart_extraction_progress.set_text(_("Cancelling..."))
    self.ui.smart_extraction_cancel.set_sensitive(False)
```

### 3. Enhanced Wallust Dialog

```python
def _show_wallust_required_dialog(self):
    """Show dialog explaining wallust is required."""
    dialog = Gtk.MessageDialog(
        self,
        Gtk.DialogFlags.MODAL,
        Gtk.MessageType.WARNING,
        Gtk.ButtonsType.OK,
        None
    )
    dialog.set_title(_("wallust Required"))

    dialog.format_secondary_markup(
        _("<b>wallust</b> is required for color-aware selection.\n\n"
          "<b>Installation Options:</b>\n"
          "  Cargo: <tt>cargo install wallust</tt>\n"
          "  Arch: <tt>pacman -S wallust</tt>\n"
          "  Nix: <tt>nix-env -iA nixpkgs.wallust</tt>\n\n"
          "<b>After installation:</b>\n"
          "  1. Run <tt>wallust run &lt;any_image&gt;</tt> to initialize\n"
          "  2. Re-enable color features in Variety")
    )

    dialog.run()
    dialog.destroy()
```

### 4. Instance Variables

Add to `PreferencesVarietyDialog`:

```python
# In finish_initializing or reload:
self._extraction_cancelled = False
self._extraction_thread = None
```

---

## Threading Model

The codebase uses this established pattern:

```python
def some_async_operation():
    def background_work():
        try:
            result = expensive_operation()

            def update_ui():
                self.some_widget.set_text(result)
            Util.add_mainloop_task(update_ui)

        except Exception:
            logger.exception(...)
            Util.add_mainloop_task(show_error)

    threading.Thread(target=background_work, daemon=True).start()
```

Key points:
- `Util.add_mainloop_task()` uses `Gdk.threads_add_idle()` - safe for GTK
- All GTK widget manipulation MUST happen in main thread
- Background threads should be `daemon=True`

---

## Summary of Changes

| Component | Current State | Proposed Change |
|-----------|---------------|-----------------|
| Extract Progress | Text in button label | GtkProgressBar + Cancel button |
| Cancellation | Not supported | Flag + InterruptedError pattern |
| Wallust Check | Basic notification | Detailed dialog with instructions |
| Thumbnail Loading | Already async | No change needed |

---

## Files to Modify

1. **`data/ui/PreferencesVarietyDialog.ui`** - Add progress bar and cancel button
2. **`variety/PreferencesVarietyDialog.py`** - Update handlers, add cancellation
