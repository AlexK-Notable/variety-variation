---
created: '2025-12-06T21:32:21.304370'
id: 20251206T213221304200000
tags:
- variety
- smart-selection
- wallust
- phase3
- color-palette
- integration
title: Variety Smart Selection - Phase 3 Wallust Integration Plan
type: permanent
updated: '2025-12-06T21:37:03.398894'
---

# Variety Smart Selection - Phase 3 Wallust Integration Plan

# Phase 3: Wallust Integration - Critical Issues Found

## CRITICAL: Race Condition in record_shown

**Current broken flow:**
```
set_wallpaper():
  Line 2088: set_wp_throttled(img)  ← Returns IMMEDIATELY (spawns thread)
  Line 2093: record_shown(img)      ← Runs NOW, before wallust!

Background thread (async):
  do_set_wp() → set_desktop_wallpaper() → subprocess.check_call(script)
  → Script runs wallust (creates cache AFTER record_shown already ran)
```

**FIX:** Move `record_shown` INTO `do_set_wp()` AFTER `set_desktop_wallpaper()` completes, then read wallust cache.

## UI Issues Found

1. **Extract Palettes button**: No progress bar, button stays active (user can click multiple times), no cancellation
2. **Thumbnail loading**: `_populate_dialog_flowbox()` loads 60 images synchronously - freezes UI
3. **No wallust check**: User can enable color features without wallust installed

## Hardcoded Issues

- `palette.py` looks for `*Dark16*` files but wallust palette type is configurable
- Should read from `~/.config/wallust/wallust.toml` to detect palette type

## Correct Integration Point

```python
# In do_set_wp() - AFTER set_desktop_wallpaper()
def do_set_wp(self, filename, refresh_level=RefreshLevel.ALL):
    with self.do_set_wp_lock:
        # ... existing code ...
        self.set_desktop_wallpaper(to_set, filename, ...)
        self.current = filename

        # Record AFTER script completes (wallust has run)
        if self.smart_selector:
            palette = self._read_wallust_cache_for_image(filename)
            self.smart_selector.record_shown(filename, wallust_palette=palette)
```

## Full Plan Location
`docs/PHASE3_WALLUST_INTEGRATION_PLAN.md`