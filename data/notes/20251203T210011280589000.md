---
created: '2025-12-03T21:00:11.280613'
id: 20251203T210011280589000
tags:
- variety
- implementation-plan
- smart-selection
- wallust
- architecture
- roadmap
title: Variety Smart Selection Engine - Implementation Plan
type: structure
updated: '2025-12-03T21:56:02.207194'
---

# Variety Smart Selection Engine - Implementation Plan

# Smart Selection Engine Implementation Plan

# Smart Selection Engine Implementation Plan

## Overview

Replace Variety's random wallpaper selection with an intelligent weighted selection engine featuring:
- Image recency penalty (don't repeat for N days)
- Source rotation (balance across wallpaper sources)
- Favorites boost
- Wallust color palette indexing
- Color-aware selection (palette similarity, temperature, lightness)

## Module Structure

```
variety/
  smart_selection/
    __init__.py          # Public API: SmartSelector
    models.py            # ImageRecord, PaletteRecord, SourceRecord dataclasses
    database.py          # SQLite operations, schema, migrations
    config.py            # SelectionConfig dataclass
    indexer.py           # Background directory scanning
    palette.py           # Wallust integration (Phase 3)
    weights.py           # Weight calculation strategies ✅
    selector.py          # Main orchestrator ✅
```

### Dependency Graph
```
models.py (no deps)
    ↑
database.py → config.py
    ↑
palette.py
    ↑
indexer.py
    ↑
weights.py
    ↑
selector.py → __init__.py
```

## Database Schema (Implemented)

```sql
CREATE TABLE images (
    filepath TEXT PRIMARY KEY,
    filename TEXT NOT NULL,
    source_id TEXT,
    width INTEGER,
    height INTEGER,
    aspect_ratio REAL,
    file_size INTEGER,
    file_mtime INTEGER,
    is_favorite INTEGER DEFAULT 0,
    first_indexed_at INTEGER,
    last_indexed_at INTEGER,
    last_shown_at INTEGER,
    times_shown INTEGER DEFAULT 0
);

CREATE TABLE palettes (
    filepath TEXT PRIMARY KEY,
    color0-15 TEXT,              -- wallust 16 colors
    background TEXT,
    foreground TEXT,
    avg_hue REAL,                -- derived: 0-360
    avg_saturation REAL,         -- derived: 0-1
    avg_lightness REAL,          -- derived: 0-1
    color_temperature REAL,      -- derived: -1 to +1
    indexed_at INTEGER,
    FOREIGN KEY (filepath) REFERENCES images(filepath)
);

CREATE TABLE sources (
    source_id TEXT PRIMARY KEY,
    source_type TEXT,
    last_shown_at INTEGER,
    times_shown INTEGER DEFAULT 0
);
```

## Public API (Implemented)

```python
class SmartSelector:
    def __init__(self, db_path: str, config: SelectionConfig)
    def select_images(self, count: int, constraints: SelectionConstraints = None) -> List[str]
    def record_shown(self, filepath: str, wallust_palette: dict = None)
    # Phase 3+
    def get_similar_by_palette(self, palette: dict, count: int) -> List[str]
    def start_background_indexing(self, directories: List[str])
    def stop_background_indexing()
```

## Weight Calculation (Implemented)

```python
weight(image) = 
    recency_factor(image.last_shown_at, cooldown_days) *
    source_factor(source.last_shown_at, source_cooldown) *
    favorite_boost(image.is_favorite) *
    new_image_boost(image.times_shown == 0) *
    color_affinity(image.palette, target_palette)  # Phase 4
```

- **Decay options**: exponential (sigmoid S-curve), linear, step (hard cutoff)
- **Cooldowns**: image_cooldown_days=7, source_cooldown_days=1 (configurable)
- **Boosts**: favorite_boost=2.0, new_image_boost=1.5 (configurable)

## Integration Points (VarietyWindow.py) ✅

1. **_init_smart_selector()** (~line 315): Create SmartSelector, start background indexing
2. **select_random_images()** (~line 1638): Delegate to SmartSelector.select_images() with fallback
3. **_smart_index_images()** (~line 1668): Index new images on-the-fly
4. **set_wallpaper()** (~line 1860): Call record_shown() for recency tracking
5. **on_quit()** (~line 2336): Close SmartSelector resources

## Configuration Options (Options.py) - TODO

```python
smart_selection_enabled = True
image_cooldown_days = 7
source_cooldown_days = 1
favorite_boost = 2.0
new_image_boost = 1.5
color_continuity_enabled = False  # Phase 4
```

## Phased Roadmap

### ✅ Phase 1: Foundation - COMPLETE
- models.py, database.py, basic indexer.py, config.py
- SQLite schema, ImageRecord, directory scanner
- Index Favorites on startup
- **Tests**: 66 passing (14 models + 24 database + 11 config + 16 indexer + 1 integration)

### ✅ Phase 2: Weighted Selection - COMPLETE
- weights.py (sigmoid decay, linear, step), selector.py
- Recency calculation, source tracking, favorites/new boosts
- Integrated into VarietyWindow.py with graceful fallback
- **Tests**: 46 new (27 weights + 19 selector) = 112 total passing

### Phase 3: Wallust Integration (Next)
- palette.py, extend schema
- Wallust subprocess, JSON parsing
- Derived metrics (hue, saturation, temperature)
- Store palette on wallpaper set
- **Deliverable**: Palettes indexed passively

### Phase 4: Color-Aware Selection
- Palette similarity calculation
- color_continuity mode
- Temperature/lightness filtering
- **Deliverable**: Color-based selection

### Phase 5: Full Collection + UI
- Index full Downloaded collection
- Preferences UI for smart selection settings
- Statistics view
- **Deliverable**: Complete feature

## Thread Safety

- SQLite: check_same_thread=False + connection per thread
- Background indexer: daemon thread (like prep_thread)
- Selector methods called from change_thread must be thread-safe

## Links
- extends [[20251203T201019613102000]] Implementation plan builds on switching logic analysis
- reference [[20251203T200154744397000]] References architecture overview