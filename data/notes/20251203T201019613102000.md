---
created: '2025-12-03T20:10:19.613126'
id: 20251203T201019613102000
tags:
- variety
- wallpaper
- threading
- timer
- architecture
- switching-logic
title: Variety - Automatic Wallpaper Switching Logic
type: permanent
updated: '2025-12-03T20:10:24.729968'
---

# Variety - Automatic Wallpaper Switching Logic

# Automatic Wallpaper Switching Analysis

## Thread Architecture

Variety uses 3 daemon threads started in `start_threads()` (VarietyWindow.py:674):

1. **change_thread** (`regular_change_thread`) - Timer loop for auto-changes
2. **prep_thread** (`prepare_thread`) - Pre-downloads/filters images
3. **dl_thread** (`download_thread`) - Background source downloads

## Key State Variables

- `change_event` (threading.Event) - Wakes timer thread early
- `change_enabled` (bool) - Auto-rotation active
- `change_interval` (int) - Seconds between changes (default: 300)
- `last_change_time` (float) - Unix timestamp of last change
- `auto_changed` (bool) - Timer-triggered vs user-triggered
- `prepared` (list) - Queue of pre-filtered images
- `used` (list) - History of shown wallpapers
- `position` (int) - Current index in history
- `current` (str) - Current wallpaper filename

## Timer Loop (line 927)

1. If `change_on_start`: wait 5s, then change
2. Loop while running:
   - Wait on `change_event` for remaining interval time
   - If `!change_enabled`: wait indefinitely
   - On wake/timeout: set `auto_changed=True`, call `change_wallpaper()`

Early wake triggers: Next, Previous, Pause/Resume, interval change

## Change Pipeline

```
change_wallpaper() :1688  - Select image from prepared[] or random
    ↓
set_wallpaper() :1768     - Update history, position, plugin hooks
    ↓
set_wp_throttled() :1248  - 0.1s throttle
    ↓
do_set_wp() :1527         - Filters, display mode, quote, clock
    ↓
set_desktop_wallpaper() :2761 - External script call
```

## RefreshLevel Optimization (line 1242)

- ALL=0: Full regeneration
- FILTERS_AND_TEXTS=1: Filters + overlays
- TEXTS=2: Quote + clock only
- CLOCK_ONLY=3: Just clock

## Extension Points

- Timing: `regular_change_thread()` :927
- Selection: `change_wallpaper()` :1688
- Processing: `do_set_wp()` :1527
- Output: `set_desktop_wallpaper()` :2761 or external script
- Hooks: `on_image_set_as_wallpaper` plugin hook

## Links
- extends [[20251203T200154744397000]] Deep dive extending architecture overview